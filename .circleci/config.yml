version: 2
jobs:
  deploy:
    docker:
      # See https://circleci.com/docs/2.0/circleci-images/ ...
      - image: circleci/python:3.6-jessie-node-browsers
    working_directory: ~/infra
    steps:
          - checkout
          # Add keys of AWS host: https://circleci.com/gh/scenarioo/scenarioo-infrastructure/edit#ssh
          - add_ssh_keys:
                fingerprints:
                  - "29:5a:f5:86:2d:e0:60:e1:7f:22:7c:0e:ad:2b:1c:40"
          - run:
              name: Install ansible
              command: sudo pip install ansible --quiet
          - run:
              name: Deploy server
              command: |
                export ANSIBLE_HOST_KEY_CHECKING=False    # TODO: Add known_hosts to repository
                ansible-playbook ./site.yml -i ./hosts/hosts_aws
  test_scripts:
    docker:
      # See https://circleci.com/docs/2.0/circleci-images/ ...
      - image: circleci/python:3.6-jessie-node-browsers
    working_directory: ~/infra
    steps:
          - checkout
          - run:
              name: Install bats
              command: sudo apt-get install bats
          - run:
              name: Run tests
              command: bats tests/

workflows:
  version: 2
  deploy_infrastructure:
    jobs:
      - test_scripts
      - deploy:
          requires:
            - test_scripts
          # Get environment vars: https://circleci.com/docs/2.0/contexts/
          context: Scenarioo    # https://circleci.com/gh/organizations/scenarioo/settings#contexts
          filters:
            branches:
              only: master  # Avoid deployment being triggered for PRs
